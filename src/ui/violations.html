<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOD Violations - Change Management Audit</title>
    <style>
        /* Common styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            background-color: #fff;
        }
        
        .section h2 {
            margin-top: 0;
            color: #3498db;
        }
        
        .nav-links {
            margin-bottom: 20px;
        }
        
        .nav-links a {
            display: inline-block;
            padding: 8px 16px;
            margin-right: 10px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-links a:hover {
            background-color: #2980b9;
        }
        
        .nav-links a.active {
            background-color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table, th, td {
            border: 1px solid #ddd;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .summary {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px 15px;
            flex: 1;
            min-width: 200px;
        }
        
        .summary-item h3 {
            margin-top: 0;
            color: #3498db;
            font-size: 16px;
        }
        
        .summary-item p {
            margin: 5px 0 0;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .error {
            color: #e74c3c;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .button-group {
            margin-top: 15px;
        }
        
        button {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .violation-high {
            background-color: #ffecec !important;
        }
        
        .violation-medium {
            background-color: #fff9e6 !important;
        }
        
        .violation-details {
            margin-top: 5px;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .filter-container {
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
        }
        
        .filter-group label {
            margin-right: 8px;
            font-weight: bold;
        }
        
        .filter-group select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SOD Violations</h1>
        
        <div class="nav-links">
            <a href="/">Dashboard</a>
            <a href="/population">Verified Population</a>
            <a href="/violations" class="active">SOD Violations</a>
        </div>
        
        <div class="section">
            <h2>Violations Summary</h2>
            <div class="summary">
                <div class="summary-item">
                    <h3>Total Violations</h3>
                    <p id="totalViolations">-</p>
                </div>
                <div class="summary-item">
                    <h3>High Risk Violations</h3>
                    <p id="highRiskViolations">-</p>
                </div>
                <div class="summary-item">
                    <h3>Medium Risk Violations</h3>
                    <p id="mediumRiskViolations">-</p>
                </div>
                <div class="summary-item">
                    <h3>Low Risk Violations</h3>
                    <p id="lowRiskViolations">-</p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>Violation Details</h2>
            
            <div class="filter-container">
                <div class="filter-group">
                    <label for="riskFilter">Risk Level:</label>
                    <select id="riskFilter">
                        <option value="all">All</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="violationTypeFilter">Violation Type:</label>
                    <select id="violationTypeFilter">
                        <option value="all">All</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                
                <button onclick="applyFilters()">Apply Filters</button>
                <button onclick="clearFilters()">Clear Filters</button>
            </div>
            
            <div class="table-container">
                <table id="violationsTable">
                    <thead>
                        <tr>
                            <th>Change ID</th>
                            <th>Title</th>
                            <th>Asset Name</th>
                            <th>Violation Type</th>
                            <th>Risk Rating</th>
                            <th>Details</th>
                            <th>Implementation Date</th>
                        </tr>
                    </thead>
                    <tbody id="violationsTableBody">
                        <tr>
                            <td colspan="7" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="button-group">
                <button onclick="exportToCSV()">Export to CSV</button>
            </div>
        </div>
    </div>
    
    <script>
        // Variables
        let violationsData = [];
        let filteredViolations = [];
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            loadViolationsData();
        });
        
        // Functions
        function loadViolationsData() {
            // First try to get data from session storage (if coming from dashboard)
            const storedResults = sessionStorage.getItem('auditResults');
            
            if (storedResults) {
                const results = JSON.parse(storedResults);
                if (results.violations && results.violations.length > 0) {
                    violationsData = results.violations;
                    filteredViolations = [...violationsData];
                    updateSummary();
                    populateViolationTypeFilter();
                    renderTable();
                    return;
                }
            }
            
            // If no data in session storage, show mock data for demonstration
            // In a real implementation, you would fetch from API
            violationsData = [
                {
                    changeId: 'CHG1006',
                    title: 'Config refinement',
                    assetName: 'Warehouse Management System',
                    violationType: 'Same user requested & approved',
                    riskRating: 'Medium',
                    details: 'Laura Taylor both requested and approved this change',
                    implementationDate: '2-2-2025 12:00'
                },
                {
                    changeId: 'CHG1017',
                    title: 'Feature toggle',
                    assetName: 'Warehouse Management System',
                    violationType: 'High risk change',
                    riskRating: 'High',
                    details: 'High risk change with standard approval',
                    implementationDate: '3-2-2025 15:00'
                }
            ];
            
            filteredViolations = [...violationsData];
            updateSummary();
            populateViolationTypeFilter();
            renderTable();
        }
        
        function updateSummary() {
            document.getElementById('totalViolations').textContent = violationsData.length;
            
            // Count by risk level
            const highRisk = violationsData.filter(v => v.riskRating === 'High').length;
            const mediumRisk = violationsData.filter(v => v.riskRating === 'Medium').length;
            const lowRisk = violationsData.filter(v => v.riskRating === 'Low').length;
            
            document.getElementById('highRiskViolations').textContent = highRisk;
            document.getElementById('mediumRiskViolations').textContent = mediumRisk;
            document.getElementById('lowRiskViolations').textContent = lowRisk;
        }
        
        function populateViolationTypeFilter() {
            const violationTypes = [...new Set(violationsData.map(v => v.violationType))];
            const select = document.getElementById('violationTypeFilter');
            
            // Clear existing options except the first one
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add new options
            violationTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }
        
        function renderTable() {
            const tableBody = document.getElementById('violationsTableBody');
            tableBody.innerHTML = '';
            
            if (filteredViolations.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.textContent = 'No violations found';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }
            
            filteredViolations.forEach(violation => {
                const row = document.createElement('tr');
                
                // Add risk-based styling
                if (violation.riskRating === 'High') {
                    row.classList.add('violation-high');
                } else if (violation.riskRating === 'Medium') {
                    row.classList.add('violation-medium');
                }
                
                // Add cells for each column
                addCell(row, violation.changeId);
                addCell(row, violation.title);
                addCell(row, violation.assetName);
                addCell(row, violation.violationType);
                addCell(row, violation.riskRating);
                addCell(row, violation.details);
                addCell(row, violation.implementationDate);
                
                tableBody.appendChild(row);
            });
        }
        
        function addCell(row, text) {
            const cell = document.createElement('td');
            cell.textContent = text || '-';
            row.appendChild(cell);
        }
        
        function applyFilters() {
            const riskFilter = document.getElementById('riskFilter').value;
            const typeFilter = document.getElementById('violationTypeFilter').value;
            
            filteredViolations = violationsData.filter(violation => {
                let matchesRisk = riskFilter === 'all' || violation.riskRating === riskFilter;
                let matchesType = typeFilter === 'all' || violation.violationType === typeFilter;
                return matchesRisk && matchesType;
            });
            
            renderTable();
        }
        
        function clearFilters() {
            document.getElementById('riskFilter').value = 'all';
            document.getElementById('violationTypeFilter').value = 'all';
            filteredViolations = [...violationsData];
            renderTable();
        }
        
        function exportToCSV() {
            // Create CSV content
            const headers = [
                'Change ID', 'Title', 'Asset Name', 'Violation Type', 
                'Risk Rating', 'Details', 'Implementation Date'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            filteredViolations.forEach(violation => {
                const row = [
                    violation.changeId,
                    `"${(violation.title || '').replace(/"/g, '""')}"`,
                    `"${(violation.assetName || '').replace(/"/g, '""')}"`,
                    `"${(violation.violationType || '').replace(/"/g, '""')}"`,
                    violation.riskRating,
                    `"${(violation.details || '').replace(/"/g, '""')}"`,
                    violation.implementationDate
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'sod_violations.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function showError(message) {
            const tableBody = document.getElementById('violationsTableBody');
            tableBody.innerHTML = `<tr><td colspan="7" class="error">${message}</td></tr>`;
        }
    </script>
</body>
</html>